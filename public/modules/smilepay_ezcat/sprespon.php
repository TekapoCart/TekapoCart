<?phpinclude_once(dirname(__FILE__) . '/../../config/config.inc.php');include_once(dirname(__FILE__) . '/../../init.php');include_once(dirname(__FILE__) . '/smilepay_ezcat.php');include_once(dirname(__FILE__) . '/../../classes/order/OrderHistory.php');include_once(dirname(__FILE__) . '/../../classes/order/Order.php');include_once(dirname(__FILE__) . '/../../classes/Context.php');// compute Midfunction midfun($Mid_value, $Amount, $Smseid, $Mid_smilepay){    $Amount = str_pad($Amount, 8, '0', STR_PAD_LEFT);    $Smseid = preg_replace('/[\D]/i', '9', substr($Smseid, -4));    $dtotal = $Mid_value . $Amount . $Smseid;    $i = 1;    $sum = strlen($dtotal);    $etemp = 0;    while ($i <= $sum) {        $ep = substr($dtotal, $i, 1);        $etemp = $etemp + $ep;        $i = $i + 2;    }    $i = 0;    $otemp = 0;    while ($i <= $sum) {        $op = substr($dtotal, $i, 1);        $otemp = $otemp + $op;        $i = $i + 2;    }    $mid = ($etemp * 3) + ($otemp * 9);    if ($Mid_smilepay == $mid) {        return true;    } else {        return false;    }}$pay_code = !empty($_REQUEST['Classif']) ? trim($_REQUEST['Classif']) : '';if (empty($pay_code)) {    $msg = '未回傳';} else {    // post value    $classif = trim($_POST['Classif']);    $data_id = trim($_POST['Data_id']);    $od_sob = trim($_POST['Od_sob']);    $amount = trim($_POST['Amount']);    $passcode_in = trim($_POST['Remark']);    $smseid = trim($_REQUEST['Smseid']);    $mid_smilepay = trim($_POST['Mid_smilepay']);    $Process_date = trim($_POST['Process_date']);    $Process_time = trim($_POST['Process_time']);    $payment_class = New Smilepay_ezcat();    $Dcvc = $payment_class->Dcvc;    $Mid = $payment_class->Mid;    // 取得訂單資訊    $order_history = new Order($data_id);    // $detail  = $history->getHistory($od_sob);    $order_db_amount = round($order_history->getOrdersTotalPaid());    /*    開始判斷    1.認證 mid_smiepay    2.確認訂單金額    3. 資訊寫入訂單    */    // checksum Mid and Mid_smilepay from SmielPay    if (isset($Mid)) {        if (!midfun($Mid, $order_db_amount, $smseid, $mid_smilepay)) {            echo "Possible fraud";            exit();        }    }    if ($amount == $order_db_amount && ($classif == 'O')) {        $ezcatbutton = "<br>Smilepay 已代收完成" . $Process_date . iconv("big5", "UTF-8", $Process_time);        // Db::getInstance()->Execute('UPDATE `'._DB_PREFIX_.'orders` SET  `payment_message` = CONCAT(`payment_message`,"'.$c2cbutton.'")  WHERE  `id_order` ='.$data_id);        $newOrderStatusId = 2;        $history = new OrderHistory();        $history->id_order = (int)($data_id);        $history->changeIdOrderState($newOrderStatusId, $data_id);        //$order_history->addOrderPayment(0, null, $smseid, null, null, null);        $history->addWithemail();        $msg = '<Roturlstatus>psok2</Roturlstatus>';        echo $msg;    } else {        $msg = '<Roturlstatus>amount error</Roturlstatus>';        echo $msg;    }}